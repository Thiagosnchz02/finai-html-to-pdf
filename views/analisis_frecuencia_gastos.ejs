<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title><%= analysisTitle %> · FinAi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <style>
    /* ===== Base (modo claro, A4, tipografía) ===== */
    @page { size: A4; margin: 20mm; }
    :root{
      --bg: #FFFFFF;
      --surface: #F7F8FA;
      --text: #0F172A;
      --muted: #475569;
      --border: #E5E7EB;
      --grid: #EEF1F4;
      --accent: #007AFF;
      --red: #FF5A5F;
      --shadow-sm: 0 1px 2px rgba(16,24,40,0.06), 0 1px 3px rgba(16,24,40,0.08);
    }
    *{ box-sizing: border-box; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    html, body{ height: 100%; }
    body{
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 400 11pt/1.55 "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", Helvetica, sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }

    .page{ max-width: 800px; margin: 0 auto; padding: 8px 0 16px; }

    /* ===== Cabecera ===== */
    .header{
      margin-bottom: 8px; padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: baseline; justify-content: space-between; gap: 12px; flex-wrap: wrap;
    }
    .title{
      margin: 0; font-size: 18pt; font-weight: 800; line-height: 1.2;
    }
    .subtitle{
      margin: 0; font-size: 11pt; color: var(--muted);
    }

    /* ===== Tarjeta del gráfico ===== */
    .chart-card{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
      padding: 16px;
      margin-top: 12px;
    }
    .chart-head{
      display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 8px;
    }
    .legend{ display: inline-flex; gap: 12px; align-items: center; font-size: 10pt; color: var(--muted); }
    .legend-item{ display: inline-flex; gap: 6px; align-items: center; }
    .legend-swatch{ width: 12px; height: 12px; border-radius: 3px; display: inline-block; background: var(--red); }

    /* Accesibilidad */
    .sr-only{
      position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0;
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- ===== Cabecera ===== -->
    <header class="header" role="banner">
      <h1 class="title"><%= analysisTitle %></h1>
      <p class="subtitle">Promedio por día de la semana</p>
    </header>

    <!-- ===== Helpers EJS ===== -->
    <%
      // Formato: usa currency si está disponible; si no, número con 2 decimales
      const _locale = 'es-ES';
      const _currency = (typeof currency !== 'undefined' && currency) ? currency : null;
      const fmt = (n) => {
        const num = Number(n)||0;
        try {
          if (_currency) return new Intl.NumberFormat(_locale, { style:'currency', currency:_currency, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);
          return new Intl.NumberFormat(_locale, { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);
        } catch { return String(num.toFixed(2)); }
      };

      // Datos
      const L = Array.isArray(labels) ? labels.map(String) : ['Lun','Mar','Mié','Jue','Vie','Sáb','Dom'];
      const ds = Array.isArray(datasets) ? datasets : [];
      const series = (ds.find(d => /promedio|medio|average|gasto/i.test(String(d?.label||'')))?.data ?? ds[0]?.data ?? []).map(Number);

      // Normalización a longitud de labels
      const N = Math.max(L.length, series.length);
      const days = (L.length ? L : Array.from({length:N}, (_,i)=>`Día ${i+1}`)).slice(0, N);
      const data = (series.length ? series : Array.from({length:N}, ()=>0)).slice(0, N);

      // Escala vertical (base cero)
      const maxVal = Math.max(1, ...data);
      function niceStep(max){
        const raw = max / 4;
        const pow = Math.pow(10, Math.floor(Math.log10(raw)));
        const n = raw / pow;
        let s = 1;
        if (n <= 1) s = 1;
        else if (n <= 2) s = 2;
        else if (n <= 5) s = 5;
        else s = 10;
        return s * pow;
      }
      const step = niceStep(maxVal);
      const tickCount = Math.max(4, Math.ceil(maxVal / step));
      const tickMax = step * tickCount;

      // Dimensiones del SVG
      const SVG_W = 760, SVG_H = 320;
      const M_LEFT = 56, M_RIGHT = 12, M_TOP = 8, M_BOTTOM = 36;
      const CH_W = SVG_W - M_LEFT - M_RIGHT;
      const CH_H = SVG_H - M_TOP - M_BOTTOM;

      // Bandas
      const bandW = CH_W / N;
      const barW = Math.max(14, Math.min(48, bandW * 0.6)); // barras cómodas
      const xBar = (i) => M_LEFT + i * bandW + (bandW - barW)/2;

      // Escala Y
      const yScale = (val) => CH_H * (1 - (val / tickMax)); // 0 en base
    %>

    <!-- ===== Gráfico de barras ===== -->
    <section class="chart-card" aria-labelledby="chartTitle">
      <div class="chart-head">
        <h2 id="chartTitle" class="sr-only">Gasto promedio por día de la semana</h2>
        <div class="legend" aria-label="Leyenda del gráfico">
          <span class="legend-item"><span class="legend-swatch"></span>Gasto promedio</span>
        </div>
      </div>

      <svg viewBox="0 0 <%= SVG_W %> <%= SVG_H %>" width="100%" height="auto" role="img" aria-label="Gráfico de barras: gasto promedio por día">
        <!-- Grid horizontal y ticks -->
        <g>
          <% for (let i = 0; i <= tickCount; i++){ 
               const val = i * step;
               const y = M_TOP + yScale(val);
          %>
            <line x1="<%= M_LEFT %>" y1="<%= y %>" x2="<%= SVG_W - M_RIGHT %>" y2="<%= y %>"
                  stroke="var(--grid)" stroke-width="1" />
            <text x="<%= M_LEFT - 8 %>" y="<%= y %>" text-anchor="end" dominant-baseline="middle"
                  fill="var(--muted)" font-size="10"><%= _currency ? fmt(val) : new Intl.NumberFormat(_locale, { maximumFractionDigits: 0 }).format(val) %></text>
          <% } %>
        </g>

        <!-- Barras -->
        <g>
          <% for (let i=0; i<N; i++){ 
               const val = data[i] || 0;
               const y = M_TOP + yScale(val);
               const h = CH_H - yScale(val);
               const x = xBar(i);
          %>
            <rect x="<%= x %>" y="<%= y %>" width="<%= barW %>" height="<%= h %>"
                  fill="var(--red)" rx="4" ry="4">
              <title><%= days[i] %>: <%= fmt(val) %></title>
            </rect>

            <!-- Etiqueta del día -->
            <text x="<%= x + barW/2 %>" y="<%= SVG_H - 16 %>" text-anchor="middle"
                  fill="var(--muted)" font-size="10"><%= days[i] %></text>
          <% } %>
        </g>

        <!-- Línea base del eje X -->
        <line x1="<%= M_LEFT %>" y1="<%= M_TOP + CH_H %>" x2="<%= SVG_W - M_RIGHT %>" y2="<%= M_TOP + CH_H %>"
              stroke="var(--border)" stroke-width="1" />
      </svg>
    </section>
  </div>
</body>
</html>
